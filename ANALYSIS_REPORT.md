# CodeVigil ç³»ç»Ÿåˆ†æä¸æ”¹è¿›å»ºè®®

## ğŸ¯ æ‚¨çš„ç›®æ ‡å¤„ç†æµç¨‹åˆ†æ

### æœŸæœ›çš„å¤„ç†æµç¨‹ï¼š
1. **è¾“å…¥Githubé“¾æ¥** â†’ æ‹‰å–ä»“åº“ â†’ æ–‡ä»¶åŒ¹é…ç­›é€‰
2. **åˆ†æ‰¹æ¬¡è¯†åˆ«é«˜å±æ–‡ä»¶**ï¼š
   - ASTé™æ€åˆ†æï¼ˆé€ä¸ªæ–‡ä»¶ï¼‰
   - Gitä¿®æ”¹æ¬¡æ•° + fixå…³é”®å­—åˆ†æï¼ˆé€ä¸ªæ–‡ä»¶ï¼‰  
   - AIæ‰¹é‡åˆ†æï¼ˆå¤šä¸ªæ–‡ä»¶ä¸€èµ·è¾“å…¥ç»™LLMï¼‰
   - ç»¼åˆä¸‰ç§ç­–ç•¥çš„å¾—åˆ† â†’ ç­›é€‰é«˜å±æ–‡ä»¶åˆ—è¡¨
3. **AIåˆ†æé«˜å±æ–‡ä»¶** â†’ è¾“å‡ºæ¼æ´æè¿° + ä»£ç ç‰‡æ®µèµ·æ­¢è¡Œ
4. **CVEçŸ¥è¯†åº“å¢å¼º** â†’ æ£€ç´¢ç›¸å…³æ¡ˆä¾‹ â†’ AIç”Ÿæˆdiff + CVEå…³è”

### ä¸‰æ¬¡AIè°ƒç”¨çš„æ˜ç¡®åˆ†å·¥ï¼š
- **ç¬¬1æ¬¡AIåˆ†æ**ï¼šæ‰¹é‡è¾“å…¥æ‰€æœ‰æ–‡ä»¶ â†’ é£é™©æ‰“åˆ† â†’ é…åˆé™æ€åˆ†æç¡®å®šé«˜å±æ–‡ä»¶
- **ç¬¬2æ¬¡AIåˆ†æ**ï¼šé€ä¸ªåˆ†æé«˜å±æ–‡ä»¶ â†’ è¾“å‡ºå…·ä½“æ¼æ´+ä¿®å¤æè¿°+ä»£ç ä½ç½®
- **ç¬¬3æ¬¡AIåˆ†æ**ï¼šç»“åˆCVEçŸ¥è¯†åº“ â†’ ç”Ÿæˆå…·ä½“diff+CVEé“¾æ¥

## âœ… å½“å‰å®ç°çš„ä¼˜ç‚¹

### å·²ç»æ­£ç¡®å®ç°çš„éƒ¨åˆ†ï¼š
1. **å®Œæ•´çš„åŸºç¡€æ¶æ„**ï¼š
   - âœ… ä»“åº“å…‹éš†å’Œæ–‡ä»¶è¿‡æ»¤åŠŸèƒ½å®Œå–„
   - âœ… å¢å¼ºå‹ASTåˆ†æå™¨å®ç°äº†æ·±åº¦é™æ€åˆ†æ
   - âœ… å®‰å…¨è§„åˆ™å¼•æ“å’Œæ¼æ´æ‰«æ
   - âœ… CVEçŸ¥è¯†åº“é›†æˆå’ŒRAGæ£€ç´¢
   - âœ… ä»»åŠ¡ç®¡ç†å’Œè¿›åº¦è·Ÿè¸ªç³»ç»Ÿ

2. **åˆ†æèƒ½åŠ›**ï¼š
   - âœ… æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€(Python/JS/Javaç­‰)
   - âœ… å¤æ‚åº¦è®¡ç®—å’Œé£é™©è¯„åˆ†ç®—æ³•
   - âœ… Gitå†å²åˆ†ææ¡†æ¶
   - âœ… AIæ¥å£é›†æˆ(DeepSeekå…¼å®¹OpenAI)

3. **æ•°æ®å¤„ç†**ï¼š
   - âœ… ç»“æ„åŒ–çš„æ¼æ´ä¿¡æ¯å­˜å‚¨
   - âœ… å¤šæ ¼å¼æŠ¥å‘Šç”Ÿæˆ(JSON/HTML/PDFç­‰)
   - âœ… WebSocketå®æ—¶è¿›åº¦æ›´æ–°

## âŒ éœ€è¦ä¿®æ­£çš„å…³é”®é—®é¢˜

### é—®é¢˜1ï¼šAIåˆ†æé˜¶æ®µè®¾è®¡ä¸ç¬¦åˆéœ€æ±‚

**å½“å‰é—®é¢˜**ï¼š
```python
# ç°æœ‰çš„ analyze_files_batch æ··åˆäº†å¤šä¸ªé˜¶æ®µ
async def analyze_files_batch(self, file_inputs, max_batch_size=5):
    # å†…éƒ¨æ—¢åšé£é™©è¯„ä¼°ï¼ŒåˆåšCVEå¢å¼ºï¼ŒèŒè´£ä¸æ¸…
    results = await self._analyze_batch_internal(batch)
    enhanced_results = await self._enhance_with_cve_knowledge(results)
```

**éœ€è¦æ”¹ä¸º**ï¼šä¸¥æ ¼åˆ†ç¦»çš„ä¸‰é˜¶æ®µåˆ†æ
```python
# é˜¶æ®µ1ï¼šçº¯é£é™©è¯„ä¼°æ‰“åˆ†
stage1_results = await self._stage1_batch_risk_scoring(all_files)

# é˜¶æ®µ2ï¼šé«˜å±æ–‡ä»¶è¯¦ç»†åˆ†æ  
high_risk_files = filter_by_score(stage1_results, threshold=70)
stage2_results = await self._stage2_detailed_vulnerability_analysis(high_risk_files)

# é˜¶æ®µ3ï¼šCVEå¢å¼ºå’Œdiffç”Ÿæˆ
stage3_results = await self._stage3_cve_enhanced_diff_generation(stage2_results)
```

### é—®é¢˜2ï¼šGitå†å²åˆ†æç¼ºå¤±

**å½“å‰é—®é¢˜**ï¼š
```python
# routes.py ç¬¬456è¡Œ
fix_commits = []  # ä¸´æ—¶ä½¿ç”¨ç©ºåˆ—è¡¨ï¼Œåç»­å¯å®Œå–„
```

**éœ€è¦è¡¥å……**ï¼šå®ç°Gitå†å²æå–åŠŸèƒ½
```python
def extract_file_git_history(self, repo_path: str, file_path: str) -> List[Dict]:
    """æå–æ–‡ä»¶çš„Gitä¿®æ”¹å†å²ï¼Œç‰¹åˆ«æ˜¯fixç›¸å…³æäº¤"""
    pass
```

### é—®é¢˜3ï¼šæ‰¹æ¬¡å¤„ç†ç­–ç•¥ä¸æ˜ç¡®

**æ‚¨çš„éœ€æ±‚**ï¼š
- ASTåˆ†æï¼šé€ä¸ªæ–‡ä»¶
- Gitåˆ†æï¼šé€ä¸ªæ–‡ä»¶  
- AIåˆ†æï¼šæ‰¹é‡æ–‡ä»¶ä¸€èµ·è¾“å…¥

**å½“å‰å®ç°**ï¼šæ··åˆäº†æ‰¹æ¬¡å¤§å°æ§åˆ¶ï¼Œä½†æ²¡æœ‰æ˜ç¡®åŒºåˆ†ä¸åŒç­–ç•¥çš„å¤„ç†æ–¹å¼ã€‚

## ğŸ”§ å…·ä½“æ”¹è¿›å»ºè®®

### 1. é‡æ„ä¸»åˆ†ææµç¨‹

æˆ‘å·²ç»åœ¨AIåˆ†æå™¨ä¸­æ·»åŠ äº† `analyze_files_strict_three_stage` æ–¹æ³•ï¼Œä¸¥æ ¼æŒ‰ç…§æ‚¨çš„ä¸‰é˜¶æ®µéœ€æ±‚è®¾è®¡ï¼š

```python
async def analyze_files_strict_three_stage(
    self, file_inputs: List[FileAnalysisInput], 
    stage1_batch_size: int = 10,
    risk_threshold: float = 70.0
) -> Dict[str, Any]:
    """
    ä¸¥æ ¼ä¸‰é˜¶æ®µåˆ†æï¼š
    é˜¶æ®µ1: æ‰¹é‡é£é™©è¯„ä¼° â†’ ç­›é€‰é«˜å±æ–‡ä»¶
    é˜¶æ®µ2: é«˜å±æ–‡ä»¶è¯¦ç»†åˆ†æ â†’ æ¼æ´+ä¿®å¤æè¿°  
    é˜¶æ®µ3: CVEå¢å¼º â†’ diffç”Ÿæˆ+CVEå…³è”
    """
```

### 2. è¡¥å……Gitå†å²åˆ†æ

å»ºè®®åœ¨ `RepositoryManager` ä¸­æ·»åŠ ï¼š

```python
def extract_file_git_history(self, repo_path: str, file_path: str) -> List[Dict]:
    """æå–æ–‡ä»¶çš„Gitä¿®æ”¹å†å²"""
    repo = git.Repo(repo_path)
    commits = list(repo.iter_commits(paths=file_path, max_count=50))
    
    fix_commits = []
    for commit in commits:
        message = commit.message.lower()
        if any(keyword in message for keyword in ['fix', 'patch', 'security', 'vuln']):
            fix_commits.append({
                'hash': commit.hexsha,
                'message': commit.message,
                'author': str(commit.author),
                'date': commit.committed_datetime,
                'is_fix': True
            })
    
    return fix_commits
```

### 3. æ˜ç¡®æ‰¹æ¬¡å¤„ç†ç­–ç•¥

åœ¨ `run_analysis_pipeline` ä¸­ï¼š

```python
# 1. ASTåˆ†æ - é€ä¸ªæ–‡ä»¶
for file_path in filtered_files:
    ast_result = file_analyzer._analyze_single_file(repo_path, file_path, git_history)

# 2. Gitåˆ†æ - é€ä¸ªæ–‡ä»¶  
for file_path in filtered_files:
    git_result = repo_manager.extract_file_git_history(repo_path, file_path)

# 3. AIåˆ†æ - æ‰¹é‡å¤„ç†
ai_results = await ai_analyzer.analyze_files_strict_three_stage(
    all_file_inputs, 
    stage1_batch_size=10
)
```

## ğŸš€ å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰ï¼š
1. âœ… **å·²å®Œæˆ**ï¼šé‡æ„AIåˆ†æå™¨çš„ä¸‰é˜¶æ®µæ–¹æ³•
2. **éœ€è¦è¡¥å……**ï¼šGitå†å²åˆ†æåŠŸèƒ½
3. **éœ€è¦æ›´æ–°**ï¼šä¸»åˆ†ææµç¨‹ä½¿ç”¨æ–°çš„ä¸‰é˜¶æ®µæ–¹æ³•

### ä¸­ä¼˜å…ˆçº§ï¼š
1. ä¼˜åŒ–æ‰¹æ¬¡å¤§å°å’Œæ€§èƒ½å‚æ•°
2. å¢å¼ºé”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥
3. å®Œå–„æ—¥å¿—å’Œç›‘æ§

### ä½ä¼˜å…ˆçº§ï¼š
1. UIç•Œé¢ä¼˜åŒ–
2. æ›´å¤šæ–‡ä»¶ç±»å‹æ”¯æŒ
3. æ€§èƒ½ä¼˜åŒ–

## ğŸ“Š å½“å‰åŒ¹é…åº¦è¯„ä¼°

| åŠŸèƒ½æ¨¡å— | åŒ¹é…åº¦ | çŠ¶æ€ |
|---------|--------|------|
| ä»“åº“å…‹éš†ä¸æ–‡ä»¶ç­›é€‰ | 95% | âœ… å·²å®Œæˆ |
| ASTé™æ€åˆ†æ | 90% | âœ… å·²å®Œæˆ |
| Gitå†å²åˆ†æ | 30% | âŒ éœ€è¦è¡¥å…… |
| ä¸‰é˜¶æ®µAIåˆ†æ | 70% | âš ï¸ å·²é‡æ„ï¼Œéœ€æµ‹è¯• |
| CVEçŸ¥è¯†åº“é›†æˆ | 85% | âœ… åŸºæœ¬å®Œæˆ |
| æŠ¥å‘Šç”Ÿæˆ | 90% | âœ… å·²å®Œæˆ |
| æ•´ä½“æ¶æ„ | 85% | âœ… åŸºæœ¬ç¬¦åˆ |

## ğŸ¯ æ€»ç»“

æ‚¨çš„ç³»ç»Ÿæ¶æ„è®¾è®¡**åŸºæœ¬æ­£ç¡®**ï¼Œæ ¸å¿ƒåŠŸèƒ½**å¤§éƒ¨åˆ†å·²å®ç°**ã€‚ä¸»è¦é—®é¢˜åœ¨äºï¼š

1. **AIåˆ†æé˜¶æ®µçš„èŒè´£åˆ’åˆ†ä¸å¤Ÿæ¸…æ™°** - å·²é€šè¿‡é‡æ„è§£å†³
2. **Gitå†å²åˆ†æåŠŸèƒ½ç¼ºå¤±** - éœ€è¦è¡¥å……å®ç°  
3. **æ‰¹æ¬¡å¤„ç†ç­–ç•¥éœ€è¦æ˜ç¡®** - éœ€è¦è°ƒæ•´ä¸»æµç¨‹

ä¿®å¤è¿™äº›é—®é¢˜åï¼Œæ‚¨çš„ç³»ç»Ÿå°†èƒ½å¤Ÿ**å®Œå…¨æ»¡è¶³**æè¿°çš„å¤„ç†æµç¨‹è¦æ±‚ã€‚å½“å‰çš„ä»£ç è´¨é‡å¾ˆé«˜ï¼Œæ¶æ„è®¾è®¡åˆç†ï¼Œåªéœ€è¦é’ˆå¯¹æ€§çš„è°ƒæ•´å³å¯ã€‚
